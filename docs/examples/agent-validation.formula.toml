description = """
End-to-end agent validation run by the mayor.

Configures town and rig settings for a target agent, spawns a polecat,
inspects its prompt for correct Gas Town context injection, gives it a
test task, and verifies execution. Cleans up afterward.

## Usage

```bash
gt formula run agent-validation --agent=pi --rig=pi_agent
gt formula run agent-validation --agent=opus-46 --rig=sfgastown --task="read src/main.rs and report the first 5 lines"
```

## What it does

1. **Configure**: Sets the target agent in town and rig settings
2. **Spawn**: Slings a test bead to the target rig, spawning a polecat
3. **Inspect**: Captures the polecat's tmux pane output, verifies Gas Town context
4. **Task**: Nudges the polecat with a test task, verifies it executes
5. **Report**: Summarizes pass/fail and cleans up

## Variables

| Variable | Default | Description |
|----------|---------|-------------|
| agent | (required) | Agent name from settings (e.g., "pi", "opus-46") |
| rig | (required) | Rig to spawn the polecat in (e.g., "pi_agent", "sfgastown") |
| task | "report your role and hooked work" | Test task to give the polecat |
| restore_config | true | Whether to restore settings after test |
"""
formula = "agent-validation"
type = "workflow"
version = 1

[vars.agent]
description = "Agent name to test (must exist in town settings or be a built-in preset)"
required = true

[vars.rig]
description = "Rig to spawn the test polecat in"
required = true

[vars.task]
description = "Test task to give the polecat after verifying prompt injection"
required = false
default = "Report your role, your hooked work (gt hook), and confirm you received Gas Town context. Include the text VALIDATION_OK in your response."

[vars.restore_config]
description = "Whether to restore settings/config.json after test (true/false)"
required = false
default = "true"

[[steps]]
id = "preflight"
title = "Verify prerequisites and back up config"
description = """
Ensure infrastructure is ready and save current settings.

**1. Verify tools:**
```bash
gt --version
bd --version
```

**2. Verify Dolt server:**
```bash
mysql -h 127.0.0.1 -P 3307 -u root -e "SELECT 1"
```

**3. Verify the agent exists in config:**
```bash
python3 -c "
import json
with open('$HOME/gt/settings/config.json') as f:
    cfg = json.load(f)
agents = cfg.get('agents', {})
builtins = {'claude','pi','opencode','gemini','codex','cursor','auggie','amp'}
name = '{{agent}}'
if name in agents:
    agent = agents[name]
    print(f'Agent: {name}')
    print(f'  command: {agent.get(\"command\", \"?\")}')
    print(f'  args: {agent.get(\"args\", [])}')
    print(f'  env: {list(agent.get(\"env\", {}).keys())}')
elif name in builtins:
    print(f'Agent: {name} (built-in preset)')
else:
    print(f'ERROR: Agent \"{name}\" not found')
    exit(1)
"
```

**4. Verify the agent binary resolves:**
```bash
python3 -c "
import json, subprocess
with open('$HOME/gt/settings/config.json') as f:
    cfg = json.load(f)
agent = cfg.get('agents', {}).get('{{agent}}', {})
cmd = agent.get('command', '{{agent}}')
result = subprocess.run(['which', cmd], capture_output=True, text=True)
if result.returncode == 0:
    print(f'Binary: {result.stdout.strip()}')
else:
    print(f'ERROR: Binary not found: {cmd}')
    exit(1)
"
```

**5. Verify the rig exists:**
```bash
test -d "$HOME/gt/{{rig}}" || { echo "ERROR: Rig {{rig}} not found"; exit 1; }
gt rig list | grep -q "{{rig}}"
```

**6. Check memory (don't spawn if box is low):**
```bash
free -h
# Available memory should be > 1.5GB to safely spawn an agent
```

**7. Back up current config:**
```bash
cp ~/gt/settings/config.json ~/gt/settings/config.json.agent-validation-backup
```

**Exit criteria:** Tools available, agent and rig exist, config backed up."""

[[steps]]
id = "configure-settings"
title = "Configure town and rig settings for target agent"
needs = ["preflight"]
description = """
Set role_agents.polecat to the target agent at both town and rig level.

**1. Set town-level polecat agent:**
```bash
python3 -c "
import json
with open('$HOME/gt/settings/config.json') as f:
    cfg = json.load(f)
cfg.setdefault('role_agents', {})['polecat'] = '{{agent}}'
with open('$HOME/gt/settings/config.json', 'w') as f:
    json.dump(cfg, f, indent=4)
print('Town settings: role_agents.polecat = {{agent}}')
"
```

**2. Optionally set rig-level override:**
```bash
rig_config="$HOME/gt/{{rig}}/settings/config.json"
if [ -f "$rig_config" ]; then
    python3 -c "
import json
with open('$rig_config') as f:
    cfg = json.load(f)
cfg.setdefault('role_agents', {})['polecat'] = '{{agent}}'
with open('$rig_config', 'w') as f:
    json.dump(cfg, f, indent=4)
print('Rig settings: role_agents.polecat = {{agent}}')
"
fi
```

**3. Verify the setting took effect:**
```bash
python3 -c "
import json
with open('$HOME/gt/settings/config.json') as f:
    cfg = json.load(f)
polecat_agent = cfg.get('role_agents', {}).get('polecat', '?')
print(f'Configured polecat agent: {polecat_agent}')
assert polecat_agent == '{{agent}}', f'Expected {{agent}}, got {polecat_agent}'
print('OK')
"
```

**Exit criteria:** Both town and rig settings point polecat role to {{agent}}."""

[[steps]]
id = "create-test-bead"
title = "Create a test bead in the target rig"
needs = ["configure-settings"]
description = """
Create a lightweight test bead that the polecat will be assigned.

```bash
bd create --rig {{rig}} \
    --title "Agent validation: {{agent}} prompt test" \
    --description "Automated validation bead. Verify that agent '{{agent}}' receives correct Gas Town prompt context when slung to {{rig}}. Test task: {{task}}" \
    --type task \
    --priority 3
```

Record the bead ID from the output â€” you'll need it for the sling step.

**Exit criteria:** Test bead created, ID recorded."""

[[steps]]
id = "sling-polecat"
title = "Sling the test bead to spawn a polecat"
needs = ["create-test-bead"]
description = """
Use gt sling to dispatch the test bead, spawning a polecat with the configured agent.

```bash
gt sling <bead-id> {{rig}}
```

Record the polecat name and tmux session name from the output.
The session name follows the pattern: `gt-{{rig}}-<polecat-name>`

**Wait for the session to appear:**
```bash
# Poll for up to 60 seconds
for i in $(seq 1 60); do
    tmux has-session -t "gt-{{rig}}-<polecat-name>" 2>/dev/null && break
    sleep 1
done
```

**Exit criteria:** Polecat spawned, tmux session running."""

[[steps]]
id = "inspect-prompt"
title = "Inspect polecat prompt for Gas Town context"
needs = ["sling-polecat"]
description = """
Capture the polecat's tmux pane output and verify Gas Town context was injected.

**1. Wait for agent to start (give hooks time to fire):**
```bash
sleep 15   # Allow session_start + before_agent_start hooks to run
```

**2. Capture pane output:**
```bash
tmux capture-pane -t "gt-{{rig}}-<polecat-name>" -p -S -500 > /tmp/agent-validation-pane.txt
```

**3. Check for Gas Town context markers:**
```bash
grep -ciE "GAS.TOWN|gastown"            /tmp/agent-validation-pane.txt  # Town identity
grep -ciE "polecat|POLECAT"             /tmp/agent-validation-pane.txt  # Role awareness
grep -ciE "gt hook|hook.*work|assigned" /tmp/agent-validation-pane.txt  # Work assignment
grep -ciE "gt prime|startup|propulsion" /tmp/agent-validation-pane.txt  # Startup protocol
```

Each check should return > 0. Record pass/fail for each.

**4. Check for agent-specific markers:**
- **Pi agent:** Look for `[gastown] gt prime captured` in stderr (hooks fired)
- **Claude agent:** Look for `GAS TOWN` in the initial system prompt
- **OpenCode agent:** Look for context injection in startup output

**Exit criteria:** Pane captured, Gas Town context markers verified (or failures documented)."""

[[steps]]
id = "test-task"
title = "Give the polecat a test task and verify execution"
needs = ["inspect-prompt"]
description = """
Nudge the polecat with a test task and check it responds.

**1. Send the test task:**
```bash
gt nudge {{rig}}/<polecat-name> "{{task}}"
```

**2. Wait for response (up to 45 seconds):**
```bash
INITIAL=$(tmux capture-pane -t "gt-{{rig}}-<polecat-name>" -p -S -500)
for i in $(seq 1 45); do
    CURRENT=$(tmux capture-pane -t "gt-{{rig}}-<polecat-name>" -p -S -500)
    if [ "$CURRENT" != "$INITIAL" ]; then
        echo "Agent is responding (pane content changed)"
        break
    fi
    sleep 1
done
```

**3. Check for expected response markers:**
```bash
tmux capture-pane -t "gt-{{rig}}-<polecat-name>" -p -S -500 > /tmp/agent-validation-response.txt
grep -ciE "VALIDATION_OK|polecat|role|hook" /tmp/agent-validation-response.txt
```

If the agent responded with VALIDATION_OK and acknowledged its role, the test passes.

**Exit criteria:** Agent responded to nudge, test task output captured."""

[[steps]]
id = "cleanup-and-report"
title = "Clean up and report results"
needs = ["test-task"]
description = """
Nuke the test polecat, close the test bead, restore config, and summarize.

**1. Nuke the polecat:**
```bash
gt polecat nuke {{rig}}/<polecat-name> --force
```

**2. Close the test bead:**
```bash
bd close <bead-id> --reason "agent-validation formula complete"
```

**3. Restore config (if restore_config=true):**
```bash
if [ "{{restore_config}}" = "true" ] && [ -f ~/gt/settings/config.json.agent-validation-backup ]; then
    cp ~/gt/settings/config.json.agent-validation-backup ~/gt/settings/config.json
    rm ~/gt/settings/config.json.agent-validation-backup
    echo "Config restored"
fi
```

**4. Print summary:**
```
=== Agent Validation: {{agent}} in {{rig}} ===

Infrastructure:        [PASS/FAIL]
Agent binary:          [PASS/FAIL]
Settings configured:   [PASS/FAIL]
Polecat spawned:       [PASS/FAIL]
Gas Town context:      [PASS/FAIL]
  - Town identity:     [PASS/FAIL]
  - Role awareness:    [PASS/FAIL]
  - Work assignment:   [PASS/FAIL]
  - Startup protocol:  [PASS/FAIL]
Test task execution:   [PASS/FAIL]
Cleanup:               [PASS/FAIL]
```

**5. Clean up temp files:**
```bash
rm -f /tmp/agent-validation-pane.txt /tmp/agent-validation-response.txt
```

**Exit criteria:** Polecat nuked, bead closed, config restored, results summarized."""
